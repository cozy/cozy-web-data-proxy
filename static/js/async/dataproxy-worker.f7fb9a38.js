(()=>{"use strict";var e={59160:function(e,t,i){let n,r;var s=i("64271"),o=i("16396"),a=i.n(o),d=i("74450"),c=i.n(d),l=i("70999"),u=i("57198");let h=null,p=()=>new Promise((e,t)=>{if(h)return e(h);let i=indexedDB.open("sharedWorkerStorage",1);i.onupgradeneeded=e=>{!(h=e.target.result).objectStoreNames.contains("store")&&h.createObjectStore("store",{keyPath:"key"})},i.onsuccess=t=>{e(h=t.target.result)},i.onerror=e=>{t(e.target.error)}}),f=async()=>self.navigator.onLine,y={storage:{getItem:async e=>{let t=await p();return new Promise((i,n)=>{let r=t.transaction("store","readonly").objectStore("store").get(e);r.onsuccess=()=>{i(r.result?r.result.value:null)},r.onerror=()=>{n(r.error)}})},setItem:async(e,t)=>{let i=await p();return new Promise((n,r)=>{let s=i.transaction("store","readwrite").objectStore("store").put({key:e,value:t});s.onsuccess=()=>{n()},s.onerror=()=>{r(s.error)}})},removeItem:async e=>{let t=await p();return new Promise((i,n)=>{let r=t.transaction("store","readwrite").objectStore("store").delete(e);r.onsuccess=()=>{i()},r.onerror=()=>{n(r.error)}})}},events:{addEventListener:(e,t)=>{self.addEventListener(e,t)},removeEventListener:(e,t)=>{self.removeEventListener(e,t)}},pouchAdapter:u.Z,isOnline:f},m={files:{doctype:"io.cozy.files"},contacts:{doctype:"io.cozy.contacts"},apps:{doctype:"io.cozy.apps"}};var b=i("27412"),g=i("44921"),x=i("72916");let v={"io.cozy.files":["name","path"],"io.cozy.contacts":["displayName","fullname","email[]:address","address[]:formattedAddress","phone[]:number","cozy[]:url","birthday","company","jobTitle"],"io.cozy.apps":["slug","name"]},_="io.cozy.files",S="io.cozy.contacts",I="io.cozy.apps",w="directory",O="io.cozy.files.root-dir",D="io.cozy.files.shared-drives-dir",z={[I]:0,[S]:1,[_]:2},k=e=>e&&e.links.find(e=>e instanceof l.default)||null;var C=i("72294");let j=()=>C.cv,R=e=>e._type===_,A=e=>e._type===S,E=e=>e._type===I,T=(e,t,i)=>{let n=L(e,t.doc),r=q(t.doc),s=P(t.doc),o=N(e,t,i);return{doc:t.doc,type:r,title:s,name:o,url:n}},P=e=>R(e)?e.name:A(e)?e.displayName||e.fullname||null:E(e)?e.name:null,N=(e,t,i)=>{if(R(t.doc))return t.doc.path??null;if(A(t.doc)){let e;let n=t.fields.find(e=>"displayName"!==e&&"fullname"!==e);if(!n)return null;if(n.includes("[]:")){let r=n.split("[]:");if(2!==r.length)return null;let s=r[0],o=r[1],a=t.doc[s],d=Array.isArray(a)&&a.find(e=>{let t="object"==typeof e&&null!==e&&o in e&&e[o];return"string"==typeof t&&t.includes(i)});if(!d)return null;e=d[o]}else e=t.doc[n];return(null==e?void 0:e.toString())??null}if(t.doc._type===I)try{let i=e.getInstanceOptions().locale||"en";if(t.doc.locales[i])return t.doc.locales[i].short_description}catch{return t.doc.name}return null},q=e=>{if(R(e))return o.models.file.isNote(e)?"notes":"drive";return A(e)?"contacts":E(e)?e.slug:null},L=(e,t)=>{let i="",n=q(t);if(R(t)){let e=t.type===w,n=e?t._id:t.dir_id,r=`/folder/${n}`;i=o.models.file.isNote(t)?`/n/${t._id}`:o.models.file.shouldBeOpenedByOnlyOffice(t)?`/onlyoffice/${t._id}?redirectLink=drive${r}`:e?r:`${r}/file/${t._id}`}return(A(t)&&(i=`/${t._id}`),n)?(0,o.generateWebLink)({cozyUrl:e.getStackClient().uri,slug:n,subDomainType:e.getInstanceOptions().subdomain,hash:i,pathname:"",searchParams:[]}):null},M=c()("\uD83D\uDDC2️ [Replication]"),F=(e,t)=>{let i=null;return()=>{i&&(M.debug("Reset replication debounce"),clearTimeout(i)),i=setTimeout(()=>{let i=k(e);if(!!i)M.debug("Start replication after debounce of ",t),i.startReplication()},t)}},B=(e,t)=>{let i=t.type===w,n="";if(i)n=t.path??"";else{let i=e.find(e=>e._id===t.dir_id);n=i&&i.path?i.path:""}return{...t,_type:"io.cozy.files",path:n}},U=async e=>{let t=(await e.getStackClient().fetchJSON("GET","/data/io.cozy.files/_all_docs?Fields=_id,trashed,dir_id,name,path,type,mime,class,metadata.title,metadata.version&DesignDocs=false&include_docs=true")).rows.map(e=>({id:e.id,...e.doc})),i=t.filter(e=>e.type===w),n=e=>!e.trashed&&!/^\/\.cozy_trash/.test(e.path??""),r=e=>void 0!==i.find(t=>t._id===e.dir_id),s=e=>e._id!==O,o=e=>e._id!==D;return t.filter(e=>n(e)&&r(e)&&s(e)&&o(e)).map(e=>B(i,e))},$=e=>e.queryAll((0,o.Q)(S).limitBy(1e3)),H=e=>e.queryAll((0,o.Q)(I).limitBy(1e3)),Q=c()("\uD83D\uDDC2️ [Indexing]"),W=class e{indexOnChanges(){if(!!this.client)this.client.on("pouchlink:doctypesync:end",async e=>{await this.indexDocsForSearch(e)}),this.client.on("login",()=>{this.client.registerPlugin(x.RealtimePlugin,{}),this.handleUpdatedOrCreatedDoc=this.handleUpdatedOrCreatedDoc.bind(this),this.handleDeletedDoc=this.handleDeletedDoc.bind(this),this.subscribeDoctype(this.client,_),this.subscribeDoctype(this.client,S),this.subscribeDoctype(this.client,I)})}subscribeDoctype(e,t){let i=this.client.plugins.realtime;i.subscribe("created",t,this.handleUpdatedOrCreatedDoc),i.subscribe("updated",t,this.handleUpdatedOrCreatedDoc),i.subscribe("deleted",t,this.handleDeletedDoc)}handleUpdatedOrCreatedDoc(e){var t;let i=e._type;if(!i)return;let n=null===(t=this.searchIndexes)||void 0===t?void 0:t[i];if(!!n)Q.debug("[REALTIME] index doc after update : ",e),this.addDocToIndex(n.index,e),this.debouncedReplication()}handleDeletedDoc(e){var t;let i=e._type;if(!!i&&!!(null===(t=this.searchIndexes)||void 0===t?void 0:t[i]))Q.debug("[REALTIME] remove doc from index after update : ",e),this.searchIndexes[i].index.remove(e._id),this.debouncedReplication()}buildSearchIndex(e,t){let i=v[e],n=new g.Z.Document({tokenize:"forward",encode:j(),minlength:2,document:{id:"_id",index:i,store:!0}});for(let e of t)this.addDocToIndex(n,e);return n}addDocToIndex(e,t){this.shouldIndexDoc(t)&&e.add(t)}shouldIndexDoc(e){if(R(e)){let t=!e.trashed&&!/^\/\.cozy_trash/.test(e.path),i=e._id!==O,n=e._id!==D;return t&&i&&n}return!0}async indexDocsForSearch(e){let t=this.searchIndexes[e],i=k(this.client);if(!i)return null;if(!t){let t=await this.client.queryAll((0,o.Q)(e).limitBy(null)),n=this.buildSearchIndex(e,t),r=await i.getDbInfo(e);return this.searchIndexes[e]={index:n,lastSeq:null==r?void 0:r.update_seq,lastUpdated:new Date().toISOString()},this.searchIndexes[e]}let n=t.lastSeq||0,r=await i.getChanges(e,{include_docs:!0,since:n});for(let i of r.results)if(i.deleted)t.index.remove(i.id);else{let n={...i.doc,_type:e};this.addDocToIndex(t.index,n)}return t.lastSeq=r.last_seq,t.lastUpdated=new Date().toISOString(),t}search(e){if(Q.debug("[SEARCH] indexes : ",this.searchIndexes),!this.searchIndexes)return Q.warn("[SEARCH] No search index available"),[];let t=this.searchOnIndexes(e),i=this.deduplicateAndFlatten(t);return this.sortSearchResults(i).map(t=>T(this.client,t,e)).filter(e=>e.title)}searchOnIndexes(e){let t=[];for(let i in this.searchIndexes){let n=this.searchIndexes[i];if(!n){Q.warn("[SEARCH] No search index available for ",i);continue}let r=n.index.search(e,{limit:100,enrich:!0}).map(e=>({...e,doctype:i}));t=t.concat(r)}return t}deduplicateAndFlatten(e){let t=e.flatMap(e=>e.result.map(t=>({...t,field:e.field,doctype:e.doctype}))),i=new Map;return t.forEach(e=>{let{id:t,field:n,...r}=e;i.has(t)?i.get(t).fields.push(n):i.set(t,{id:t,fields:[n],...r})}),[...i.values()]}compareStrings(e,t){return e.localeCompare(t,void 0,{numeric:!0})}sortSearchResults(e){return e.sort((e,t)=>{let i=z[e.doctype]-z[t.doctype];if(0!==i)return i;if(e.doctype===I&&E(e.doc)&&E(t.doc))return this.compareStrings(e.doc.slug,t.doc.slug);if(e.doctype===S&&A(e.doc)&&A(t.doc))return this.compareStrings(e.doc.displayName,t.doc.displayName);if(e.doctype===_&&R(e.doc)&&R(t.doc))return this.sortFiles(e,t);return 0})}sortFiles(e,t){return R(e.doc)&&R(t.doc)?e.fields.includes("name")&&t.fields.includes("name")?e.doc.type!==t.doc.type?"directory"===e.doc.type?-1:1:this.compareStrings(e.doc.name,t.doc.name):e.fields.includes("name")?-1:1:0}constructor(e){(0,b._)(this,"client",void 0),(0,b._)(this,"searchIndexes",void 0),(0,b._)(this,"debouncedReplication",void 0),(0,b._)(this,"initIndexesFromStack",async()=>{Q.debug("Initializing indexes");let e=await U(this.client),t=this.buildSearchIndex("io.cozy.files",e),i=await $(this.client),n=this.buildSearchIndex("io.cozy.contacts",i),r=await H(this.client),s=this.buildSearchIndex("io.cozy.apps",r);return Q.debug("Finished initializing indexes"),this.searchIndexes={[_]:{index:t,lastSeq:0},[S]:{index:n,lastSeq:0},[I]:{index:s,lastSeq:0}},this.searchIndexes}),this.client=e,this.searchIndexes={},this.indexOnChanges(),this.debouncedReplication=F(e,3e4)}},J=c()("\uD83D\uDC77‍♂️ [shared-worker]");c().enable();let Z=new BroadcastChannel("DATA_PROXY_BROADCAST_CHANANEL"),G={setClient:async e=>{if(J.debug("Received data for setting client"),r)return;X();let t={doctypes:[_,S,I],initialSync:!0,periodicSync:!1,platform:{...y},doctypesReplicationOptions:{[_]:{strategy:"fromRemote"},[S]:{strategy:"fromRemote"},[I]:{strategy:"fromRemote"}}};(r=new(a())({uri:e.uri,token:e.token,appMetadata:{slug:"cozy-data-proxy",version:"1"},schema:m,store:!0,links:[new l.default(t)]})).instanceOptions=e.instanceOptions,r.capabilities=e.capabilities,n=new W(r),X()},search:async e=>{if(!r)throw Error("Client is required to execute a search, please initialize CozyClient");if(!n)throw Error("SearchEngine is not initialized");return n.search(e)}},X=()=>{let e={};if(r&&n&&n.searchIndexes){e.status="Ready",e.indexLength=Object.keys(n.searchIndexes).map(e=>({doctype:e,count:Object.keys(n.searchIndexes[e].index.store).length})),Z.postMessage(e);return}if(r){e.status="Client set",Z.postMessage(e);return}e.status="Waiting configuration",Z.postMessage(e)};onconnect=e=>{let t=e.ports[0];s.Jj(G,t),X()}},17770:function(){},47936:function(){},18925:function(){}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={id:n,loaded:!1,exports:{}};return e[n].call(s.exports,s,s.exports,i),s.loaded=!0,s.exports}i.m=e,i.x=()=>{var e=i.O(void 0,["465","361","362","87"],function(){return i("59160")});return e=i.O(e)},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,{a:t}),t},i.d=function(e,t){for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.f={},i.e=function(e){return Promise.all(Object.keys(i.f).reduce(function(t,n){return i.f[n](e,t),t},[]))},i.u=function(e){return"87"===e?"static/js/async/87.0a7d6b47.js":"static/js/"+(({361:"lib-react",465:"cozy"})[e]||e)+"."+({361:"6a191116",362:"d3ba348c",465:"b146a0d2"})[e]+".js"},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.nmd=function(e){return e.paths=[],!e.children&&(e.children=[]),e},(()=>{var e=[];i.O=function(t,n,r,s){if(n){s=s||0;for(var o=e.length;o>0&&e[o-1][2]>s;o--)e[o]=e[o-1];e[o]=[n,r,s];return}for(var a=1/0,o=0;o<e.length;o++){for(var n=e[o][0],r=e[o][1],s=e[o][2],d=!0,c=0;c<n.length;c++)(!1&s||a>=s)&&Object.keys(i.O).every(function(e){return i.O[e](n[c])})?n.splice(c--,1):(d=!1,s<a&&(a=s));if(d){e.splice(o--,1);var l=r();void 0!==l&&(t=l)}}return t}})(),i.p="/",i.rv=function(){return"1.0.8"},i.j="168",(()=>{var e=i.x;i.x=function(){return Promise.all(["465","361","362","87"].map(i.e,i)).then(e)}})(),(()=>{var e={168:1};i.f.i=function(t,n){!e[t]&&importScripts(i.p+i.u(t))};var t=self.webpackChunkcozy_web_data_proxy=self.webpackChunkcozy_web_data_proxy||[],n=t.push.bind(t);t.push=function(t){var r=t[0],s=t[1],o=t[2];for(var a in s)i.o(s,a)&&(i.m[a]=s[a]);for(o&&o(i);r.length;)e[r.pop()]=1;n(t)}})(),i.ruid="bundler=rspack@1.0.8",i.x()})();