(()=>{"use strict";var e={59160:function(e,t,n){let r,i;var o=n("64271"),s=n("16396"),a=n.n(s),l=n("74450"),c=n.n(l),d=n("70999"),u=n("57198");let f=null,p=()=>new Promise((e,t)=>{if(f)return e(f);let n=indexedDB.open("sharedWorkerStorage",1);n.onupgradeneeded=e=>{!(f=e.target.result).objectStoreNames.contains("store")&&f.createObjectStore("store",{keyPath:"key"})},n.onsuccess=t=>{e(f=t.target.result)},n.onerror=e=>{t(e.target.error)}}),h=async()=>self.navigator.onLine,y={storage:{getItem:async e=>{let t=await p();return new Promise((n,r)=>{let i=t.transaction("store","readonly").objectStore("store").get(e);i.onsuccess=()=>{n(i.result?i.result.value:null)},i.onerror=()=>{r(i.error)}})},setItem:async(e,t)=>{let n=await p();return new Promise((r,i)=>{let o=n.transaction("store","readwrite").objectStore("store").put({key:e,value:t});o.onsuccess=()=>{r()},o.onerror=()=>{i(o.error)}})},removeItem:async e=>{let t=await p();return new Promise((n,r)=>{let i=t.transaction("store","readwrite").objectStore("store").delete(e);i.onsuccess=()=>{n()},i.onerror=()=>{r(i.error)}})}},events:{addEventListener:(e,t)=>{self.addEventListener(e,t)},removeEventListener:(e,t)=>{self.removeEventListener(e,t)}},pouchAdapter:u.Z,isOnline:h},m={files:{doctype:"io.cozy.files"},contacts:{doctype:"io.cozy.contacts"},apps:{doctype:"io.cozy.apps"}};var g=n("27412"),b=n("44921"),x=n("72916");let v={"io.cozy.files":["name","path"],"io.cozy.contacts":["displayName","fullname","email[]:address","address[]:formattedAddress","phone[]:number","cozy[]:url","birthday","company","jobTitle"],"io.cozy.apps":["slug","name"]},w="io.cozy.files",S="io.cozy.contacts",_="io.cozy.apps",I="directory",O="file",D={[_]:0,[S]:1,[w]:2},z=e=>e&&e.links.find(e=>e instanceof d.default)||null;var k=n("72294");let C=()=>k.cv,R=e=>e._type===w,j=e=>e._type===S,A=e=>e._type===_,$=Object.keys(v),E=e=>!!e&&$.includes(e),P=(e,t)=>{let n=t.type===I,r="";if(n)r=t.path??"";else{let n=e.find(e=>e._id===t.dir_id);r=n&&n.path?n.path:""}return{...t,_type:"io.cozy.files",path:r}},T=async(e,t)=>{let n=[...t],r=n.map(e=>e.doc).filter(e=>R(e)),i=r.filter(e=>e.type===O);if(r.filter(e=>e.type===I),i.length>0){let t=N(e,i.map(e=>e.dir_id));for(let e of i){let r=t.find(t=>t._id===e.dir_id);if(r){let t=n.findIndex(t=>t.doc._id===e._id);n[t].doc.path=r.path}}}return n},N=(e,t)=>{let n=e.getCollectionFromState("io.cozy.files"),r=n.filter(e=>e.type===I);return n.filter(e=>e.type===O),r.filter(e=>t.includes(e._id))},F=e=>{let t=!e.trashed&&!/^\/\.cozy_trash/.test(e.path??""),n="io.cozy.files.root-dir"!==e._id,r="io.cozy.files.shared-drives-dir"!==e._id;return t&&n&&r},q=async(e,t,n)=>{let r=t.doc,i=B(e,r),o=U(r),s=L(r),a=M(e,{fields:t.fields,doc:r,query:n});return{doc:r,type:o,title:s,name:a,url:i}},L=e=>R(e)?e.name:j(e)?e.displayName||e.fullname||null:A(e)?e.name:null,M=(e,t)=>{let{fields:n,doc:r,query:i}=t;if(R(r))return r.path??null;if(j(r)){let e;let t=n.find(e=>"displayName"!==e&&"fullname"!==e);if(!t)return null;if(t.includes("[]:")){let n=t.split("[]:");if(2!==n.length)return null;let o=n[0],s=n[1],a=r[o],l=Array.isArray(a)&&a.find(e=>{let t="object"==typeof e&&null!==e&&s in e&&e[s];return"string"==typeof t&&t.includes(i)});if(!l)return null;e=l[s]}else e=r[t];return(null==e?void 0:e.toString())??null}if(r._type===_)try{let t=e.getInstanceOptions().locale||"en";if(r.locales[t])return r.locales[t].short_description}catch{return r.name}return null},U=e=>{if(R(e))return s.models.file.isNote(e)?"notes":"drive";return j(e)?"contacts":A(e)?e.slug:null},B=(e,t)=>{let n="",r=U(t);if(R(t)){let e=t.type===I,r=e?t._id:t.dir_id,i=`/folder/${r}`;n=s.models.file.isNote(t)?`/n/${t._id}`:s.models.file.shouldBeOpenedByOnlyOffice(t)?`/onlyoffice/${t._id}?redirectLink=drive${i}`:e?i:`${i}/file/${t._id}`}return(j(t)&&(n=`/${t._id}`),r)?(0,s.generateWebLink)({cozyUrl:e.getStackClient().uri,slug:r,subDomainType:e.getInstanceOptions().subdomain,hash:n,pathname:"",searchParams:[]}):null},H=c()("\uD83D\uDDC2️ [Replication]"),Q=(e,t)=>{let n=null;return()=>{n&&(H.debug("Reset replication debounce"),clearTimeout(n)),n=setTimeout(()=>{let n=z(e);if(!!n)H.debug("Start replication after debounce of ",t),n.startReplication()},t)}},W=async e=>{let t=(await e.getStackClient().fetchJSON("GET","/data/io.cozy.files/_all_docs?Fields=_id,trashed,dir_id,name,path,type,mime,class,metadata.title,metadata.version&DesignDocs=false&include_docs=true")).rows.map(e=>({id:e.id,...e.doc})),n=t.filter(e=>e.type===I);return t.filter(e=>F(e)).map(e=>P(n,e))},J=e=>e.queryAll((0,s.Q)(S).limitBy(1e3)),Z=e=>e.queryAll((0,s.Q)(_).limitBy(1e3)),G=c()("\uD83D\uDDC2️ [Indexing]"),X=class e{indexOnChanges(){if(!!this.client)this.client.on("pouchlink:doctypesync:end",async e=>{E(e)&&await this.indexDocsForSearch(e)}),this.client.on("login",()=>{this.client.registerPlugin(x.RealtimePlugin,{}),this.handleUpdatedOrCreatedDoc=this.handleUpdatedOrCreatedDoc.bind(this),this.handleDeletedDoc=this.handleDeletedDoc.bind(this),this.subscribeDoctype(this.client,w),this.subscribeDoctype(this.client,S),this.subscribeDoctype(this.client,_)})}subscribeDoctype(e,t){let n=e.plugins.realtime;n.subscribe("created",t,this.handleUpdatedOrCreatedDoc),n.subscribe("updated",t,this.handleUpdatedOrCreatedDoc),n.subscribe("deleted",t,this.handleDeletedDoc)}handleUpdatedOrCreatedDoc(e){var t;let n=e._type;if(!E(n))return;let r=null===(t=this.searchIndexes)||void 0===t?void 0:t[n];if(!!r)G.debug("[REALTIME] index doc after update : ",e),this.addDocToIndex(r.index,e),this.debouncedReplication()}handleDeletedDoc(e){var t;let n=e._type;if(!!E(n)&&!!(null===(t=this.searchIndexes)||void 0===t?void 0:t[n]))G.debug("[REALTIME] remove doc from index after update : ",e),this.searchIndexes[n].index.remove(e._id),this.debouncedReplication()}buildSearchIndex(e,t){let n=v[e],r=new b.Z.Document({tokenize:"forward",encode:C(),minlength:2,document:{id:"_id",index:n,store:!0}});for(let e of t)this.addDocToIndex(r,e);return r}addDocToIndex(e,t){this.shouldIndexDoc(t)&&e.add(t)}shouldIndexDoc(e){return!R(e)||F(e)}async indexDocsForSearch(e){let t=this.searchIndexes[e],n=z(this.client);if(!n)return null;if(!t){let t=performance.now(),r=await this.client.queryAll((0,s.Q)(e).limitBy(null)),i=performance.now();G.debug(`Query ${r.length} docs doctype ${e} took ${(i-t).toFixed(2)} ms`);let o=performance.now(),a=this.buildSearchIndex(e,r),l=performance.now();G.debug(`Create ${e} index took ${(l-o).toFixed(2)} ms`);let c=await n.getDbInfo(e);return this.searchIndexes[e]={index:a,lastSeq:null==c?void 0:c.update_seq,lastUpdated:new Date().toISOString()},this.searchIndexes[e]}let r=t.lastSeq||0,i=await n.getChanges(e,{include_docs:!0,since:r});for(let n of i.results)if(n.deleted)t.index.remove(n.id);else{let r={...n.doc,_type:e};this.addDocToIndex(t.index,r)}return t.lastSeq=i.last_seq,t.lastUpdated=new Date().toISOString(),t}async search(e){G.debug("[SEARCH] indexes : ",this.searchIndexes);let t=performance.now();if(!this.searchIndexes)return G.warn("[SEARCH] No search index available"),[];let n=performance.now(),r=this.searchOnIndexes(e),i=performance.now();console.log(`Search : ${i-n} ms`);let o=performance.now(),s=this.deduplicateAndFlatten(r),a=this.sortSearchResults(s),l=this.limitSearchResults(a),c=performance.now();console.log(`Post treatment : ${c-o} ms`);let d=[],u=performance.now(),f=T(this.client,l),p=performance.now();console.log(`Norm files batch : ${p-u} ms`);let h=performance.now();for(let t of f){let n=q(this.client,t,e);d.push(n)}let y=performance.now();console.log(`Normalize treatment : ${y-h} ms`);let m=d.filter(e=>e.title),g=performance.now();return console.log(`Search : ${g-t} ms`),m}searchOnIndexes(e){let t=[];for(let n in this.searchIndexes){let r=n,i=this.searchIndexes[r];if(!i){G.warn("[SEARCH] No search index available for ",r);continue}let o=performance.now(),s=i.index.search(e,100,{limit:100,enrich:!0}),a=performance.now();console.log(`Perf search : ${a-o} ms`);let l=s.map(e=>({...e,doctype:r}));t=t.concat(l)}return t}deduplicateAndFlatten(e){let t=e.flatMap(e=>e.result.map(t=>({...t,field:e.field,doctype:e.doctype}))),n=new Map;return t.forEach(e=>{let{id:t,field:r,...i}=e;if(n.has(t)){var o;null===(o=n.get(t))||void 0===o||o.fields.push(r)}else n.set(t,{id:t,fields:[r],...i})}),[...n.values()]}compareStrings(e,t){return e.localeCompare(t,void 0,{numeric:!0})}sortSearchResults(e){return e.sort((e,t)=>{let n=D[e.doctype]-D[t.doctype];if(0!==n)return n;if(e.doctype===_&&A(e.doc)&&A(t.doc))return this.compareStrings(e.doc.slug,t.doc.slug);if(e.doctype===S&&j(e.doc)&&j(t.doc))return this.compareStrings(e.doc.displayName,t.doc.displayName);if(e.doctype===w&&R(e.doc)&&R(t.doc))return this.sortFiles(e,t);return 0})}sortFiles(e,t){return R(e.doc)&&R(t.doc)?e.fields.includes("name")&&t.fields.includes("name")?e.doc.type!==t.doc.type?"directory"===e.doc.type?-1:1:this.compareStrings(e.doc.name,t.doc.name):e.fields.includes("name")?-1:1:0}limitSearchResults(e){return e.slice(0,100)}constructor(e){(0,g._)(this,"client",void 0),(0,g._)(this,"searchIndexes",void 0),(0,g._)(this,"debouncedReplication",void 0),(0,g._)(this,"initIndexesFromStack",async()=>{G.debug("Initializing indexes");let e=await W(this.client),t=this.buildSearchIndex("io.cozy.files",e),n=await J(this.client),r=this.buildSearchIndex("io.cozy.contacts",n),i=await Z(this.client),o=this.buildSearchIndex("io.cozy.apps",i);G.debug("Finished initializing indexes");let s=new Date().toISOString();return this.searchIndexes={[w]:{index:t,lastSeq:0,lastUpdated:s},[S]:{index:r,lastSeq:0,lastUpdated:s},[_]:{index:o,lastSeq:0,lastUpdated:s}},this.searchIndexes}),this.client=e,this.searchIndexes={},this.indexOnChanges(),this.debouncedReplication=Q(e,3e4)}},Y=c()("\uD83D\uDC77‍♂️ [shared-worker]");c().enable();let K=new BroadcastChannel("DATA_PROXY_BROADCAST_CHANANEL"),V={setClient:async e=>{if(Y.debug("Received data for setting client"),i)return;ee();let t={doctypes:[w,S,_],initialSync:!0,periodicSync:!1,platform:{...y},doctypesReplicationOptions:{[w]:{strategy:"fromRemote"},[S]:{strategy:"fromRemote"},[_]:{strategy:"fromRemote"}}};(i=new(a())({uri:e.uri,token:e.token,appMetadata:{slug:"cozy-data-proxy",version:"1"},schema:m,store:!0,links:[new d.default(t)]})).instanceOptions=e.instanceOptions,i.capabilities=e.capabilities,r=new X(i),ee()},search:async e=>{if(!i)throw Error("Client is required to execute a search, please initialize CozyClient");if(!r)throw Error("SearchEngine is not initialized");let t=performance.now(),n=r.search(e),o=performance.now();return Y.debug(`Search took ${o-t} ms`),n}},ee=()=>{let e={};if(i&&r&&r.searchIndexes){e.status="Ready",e.indexLength=Object.entries(r.searchIndexes).map(e=>{let[t,n]=e;return{doctype:t,count:Object.keys(n.index.store).length}}),K.postMessage(e);return}if(i){e.status="Client set",K.postMessage(e);return}e.status="Waiting configuration",K.postMessage(e)};onconnect=e=>{let t=e.ports[0];o.Jj(V,t),ee()}},17770:function(){},47936:function(){},18925:function(){}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={id:r,loaded:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}n.m=e,n.x=()=>{var e=n.O(void 0,["465","361","362","87"],function(){return n("59160")});return e=n.O(e)},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=function(e){return Promise.all(Object.keys(n.f).reduce(function(t,r){return n.f[r](e,t),t},[]))},n.u=function(e){return"87"===e?"static/js/async/87.0a7d6b47.js":"static/js/"+(({361:"lib-react",465:"cozy"})[e]||e)+"."+({361:"6a191116",362:"d3ba348c",465:"849f3ebc"})[e]+".js"},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=function(e){return e.paths=[],!e.children&&(e.children=[]),e},(()=>{var e=[];n.O=function(t,r,i,o){if(r){o=o||0;for(var s=e.length;s>0&&e[s-1][2]>o;s--)e[s]=e[s-1];e[s]=[r,i,o];return}for(var a=1/0,s=0;s<e.length;s++){for(var r=e[s][0],i=e[s][1],o=e[s][2],l=!0,c=0;c<r.length;c++)(!1&o||a>=o)&&Object.keys(n.O).every(function(e){return n.O[e](r[c])})?r.splice(c--,1):(l=!1,o<a&&(a=o));if(l){e.splice(s--,1);var d=i();void 0!==d&&(t=d)}}return t}})(),n.p="/",n.rv=function(){return"1.0.8"},n.j="168",(()=>{var e=n.x;n.x=function(){return Promise.all(["465","361","362","87"].map(n.e,n)).then(e)}})(),(()=>{var e={168:1};n.f.i=function(t,r){!e[t]&&importScripts(n.p+n.u(t))};var t=self.webpackChunkcozy_web_data_proxy=self.webpackChunkcozy_web_data_proxy||[],r=t.push.bind(t);t.push=function(t){var i=t[0],o=t[1],s=t[2];for(var a in o)n.o(o,a)&&(n.m[a]=o[a]);for(s&&s(n);i.length;)e[i.pop()]=1;r(t)}})(),n.ruid="bundler=rspack@1.0.8",n.x()})();