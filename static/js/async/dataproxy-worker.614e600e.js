(()=>{"use strict";var e={11916:function(e,t,o){let i,n,r;var l=o("64271"),c=o("16396"),a=o.n(c),d=o("74450"),s=o.n(d);let u={files:{doctype:"io.cozy.files"},contacts:{doctype:"io.cozy.contacts"},apps:{doctype:"io.cozy.apps"}};var f=o("44921"),p=o("72294");let y={"io.cozy.files":["name","path"],"io.cozy.contacts":["displayName","fullname","email[]:address","address[]:formattedAddress","phone[]:number","cozy[]:url","birthday","company","jobTitle"],"io.cozy.apps":["slug","name"]},h="io.cozy.files",m="io.cozy.contacts",g="io.cozy.apps",b="directory",v={[g]:0,[m]:1,[h]:2},_=(e,t)=>{let o=t.type===b,i="";if(o)i=t.path??"";else{let o=e.find(e=>e._id===t.dir_id);i=o&&o.path?o.path:""}return{...t,_type:"io.cozy.files",path:i}},z=async e=>{let t=await e.getStackClient().fetchJSON("GET","/data/io.cozy.files/_all_docs?Fields=_id,trashed,dir_id,name,path,type,mime,class,metadata.title,metadata.version&DesignDocs=false&include_docs=true");console.log({resp:t});let o=t.rows.map(e=>({id:e.id,...e.doc})),i=o.filter(e=>e.type===b);console.log({files:o,folders:i});let n=e=>!e.trashed&&!/^\/\.cozy_trash/.test(e.path??""),r=e=>void 0!==i.find(t=>t._id===e.dir_id),l=e=>"io.cozy.files.root-dir"!==e._id,c=e=>"io.cozy.files.shared-drives-dir"!==e._id,a=o.filter(e=>n(e)&&r(e)&&l(e)&&c(e));return console.log("normalizedFilesPrevious",a),a.map(e=>_(i,e))},x=e=>e.queryAll((0,c.Q)(m).limitBy(1e3)),w=e=>e.queryAll((0,c.Q)(g).limitBy(1e3)),O=s()("\uD83D\uDDC2️ [Indexing]"),k=async e=>{O.debug("Initializing indexes");let t=P("io.cozy.files",await z(e)),o=P("io.cozy.contacts",await x(e)),i=P("io.cozy.apps",await w(e));return O.debug("Finished initializing indexes"),[{index:t,doctype:h},{index:o,doctype:m},{index:i,doctype:g}]},C=(e,t)=>{O.debug("Searching on indexes");let o=[];for(let i of t){let t=i.index.search(e,20,{enrich:!0}).map(e=>({...e,doctype:i.doctype}));o=o.concat(t)}return O.debug("Finished seaching on indexes"),o},S=e=>{let t=e.flatMap(e=>e.result.map(t=>({...t,field:e.field,doctype:e.doctype}))),o=new Map;return t.forEach(e=>{let{id:t,field:i,...n}=e;o.has(t)?o.get(t).fields.push(i):o.set(t,{id:t,fields:[i],...n})}),[...o.values()]},j=e=>N(E(e)),E=e=>e.sort((e,t)=>{let o=v[e.doctype]-v[t.doctype];if(0!==o)return o;if(e.doctype===g)return e.doc.slug.localeCompare(t.doc.slug);if(e.doctype===m)return e.doc.displayName.localeCompare(t.doc.displayName);if(e.doctype===h)return e.doc.type!==t.doc.type?"directory"===e.doc.type?-1:1:e.doc.name.localeCompare(t.doc.name);return 0}),N=e=>{let t={[g]:[],[m]:[],[h]:[]};return e.forEach(e=>{let o=e.doctype;t[o].length<20&&t[o].push(e)}),[...t[g],...t[m],...t[h]]},P=(e,t)=>{let o=y[e],i=new f.Z.Document({tokenize:"forward",encode:p.cv,document:{id:"_id",index:o,store:!0}});for(let e of(console.log("[INDEX] start index docs"),console.log("first doc to index: ",t[0]),console.time("indexDocs"),t))i.add(e);return console.timeEnd("indexDocs"),i},A=e=>e._type===h,D=e=>e._type===m,R=e=>e._type===g,T=(e,t,o)=>{let i=B(e,t.doc),n=F(t.doc),r=$(t.doc),l=M(e,t,o);return{doc:t.doc,type:n,title:r,name:l,url:i}},$=e=>A(e)?e.name:D(e)?e.displayName||e.fullname:R(e)?e.name:void 0,M=(e,t,o)=>{if(A(t.doc))return t.doc.path;if(D(t.doc)){let e;let i=t.fields.find(e=>"displayName"!==e&&"fullname"!==e);if(!i)return null;if(console.log("look for field ",i),i.includes("[]:")){let n=i.split("[]:");if(2!==n.length)return null;let r=n[0],l=n[1];e=(t.doc[r]&&t.doc[r].find(e=>e[l]&&e[l].includes(o)))[l]}else e=t.doc[i];return console.log("matching value contact : ",e),e}if(t.doc._type===g)try{let o=e.instanceOptions.locale||"en";if(t.doc.locales[o])return t.doc.locales[o].short_description}catch{return t.doc.name}return null},F=e=>{if(A(e))return c.models.file.isNote(e)?"notes":"drive";return D(e)?"contacts":R(e)?e.slug:null},B=(e,t)=>{let o="",i=F(t);if(A(t)){let e=t.type===b,i=e?t._id:t.dir_id,n=`/folder/${i}`;o=c.models.file.isNote(t)?`/n/${t._id}`:c.models.file.shouldBeOpenedByOnlyOffice(t)?`/onlyoffice/${t._id}?redirectLink=drive${n}`:e?n:`${n}/file/${t._id}`}return(D(t)&&(o=`/${t._id}`),i)?(0,c.generateWebLink)({cozyUrl:e.getStackClient().uri,slug:i,subDomainType:e.getInstanceOptions().subdomain,hash:o,pathname:"",searchParams:[]}):null},H=s()("\uD83D\uDC77‍♂️ [shared-worker]");s().enable();let I={setClient:async e=>{if(H.debug("Received data for setting client"),!i&&(q(),(i=new(a())({uri:e.uri,token:e.token,appMetadata:{slug:"cozy-data-proxy",version:"1"},schema:u,store:!0})).instanceOptions=e.instanceOptions,i.capabilities=e.capabilities,!n)){q();let e=await k(i);q(),n=e}},search:async e=>{if(H.debug("Received data for search"),!i)throw Error("Client is required to execute a seach, please initialize CozyClient");if(!n)return[];H.debug("[SEARCH] indexes : ",n);let t=C(e,n);console.log("[SEARCH] results : ",t);let o=S(t);console.log("[SEARCH] dedup : ",o);let r=j(o);return console.log("[SEARCH] sort : ",r),r.map(t=>T(i,t,e))},onStateUpdate:e=>{r=e,q()}},q=()=>{let e={};if(i&&n){e.status="Ready",null==r||r(e);return}if(i){e.status="Client set",null==r||r(e);return}e.status="Waiting configuration",null==r||r(e)};onconnect=e=>{let t=e.ports[0];l.Jj(I,t)}},17770:function(){},18925:function(){}},t={};function o(i){var n=t[i];if(void 0!==n)return n.exports;var r=t[i]={id:i,loaded:!1,exports:{}};return e[i].call(r.exports,r,r.exports,o),r.loaded=!0,r.exports}o.m=e,o.x=()=>{var e=o.O(void 0,["465","361","689","187"],function(){return o("11916")});return e=o.O(e)},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,{a:t}),t},o.d=function(e,t){for(var i in t)o.o(t,i)&&!o.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o.f={},o.e=function(e){return Promise.all(Object.keys(o.f).reduce(function(t,i){return o.f[i](e,t),t},[]))},o.u=function(e){return"187"===e?"static/js/async/187.4f18c038.js":"static/js/"+(({361:"lib-react",465:"cozy"})[e]||e)+"."+({361:"6a191116",465:"8ab9261a",689:"2ecc0aa7"})[e]+".js"},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.nmd=function(e){return e.paths=[],!e.children&&(e.children=[]),e},(()=>{var e=[];o.O=function(t,i,n,r){if(i){r=r||0;for(var l=e.length;l>0&&e[l-1][2]>r;l--)e[l]=e[l-1];e[l]=[i,n,r];return}for(var c=1/0,l=0;l<e.length;l++){for(var i=e[l][0],n=e[l][1],r=e[l][2],a=!0,d=0;d<i.length;d++)(!1&r||c>=r)&&Object.keys(o.O).every(function(e){return o.O[e](i[d])})?i.splice(d--,1):(a=!1,r<c&&(c=r));if(a){e.splice(l--,1);var s=n();void 0!==s&&(t=s)}}return t}})(),o.p="/",o.rv=function(){return"1.0.8"},(()=>{var e=o.x;o.x=function(){return Promise.all(["465","361","689","187"].map(o.e,o)).then(e)}})(),(()=>{var e={168:1};o.f.i=function(t,i){!e[t]&&importScripts(o.p+o.u(t))};var t=self.webpackChunkcozy_web_data_proxy=self.webpackChunkcozy_web_data_proxy||[],i=t.push.bind(t);t.push=function(t){var n=t[0],r=t[1],l=t[2];for(var c in r)o.o(r,c)&&(o.m[c]=r[c]);for(l&&l(o);n.length;)e[n.pop()]=1;i(t)}})(),o.ruid="bundler=rspack@1.0.8",o.x()})();