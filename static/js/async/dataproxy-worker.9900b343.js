(()=>{"use strict";var e={11916:function(e,t,i){let o,n;var r=i("64271"),l=i("16396"),a=i.n(l),c=i("74450"),s=i.n(c);let d={files:{doctype:"io.cozy.files"},contacts:{doctype:"io.cozy.contacts"},apps:{doctype:"io.cozy.apps"}};var u=i("44921"),f=i("72294");let p={"io.cozy.files":["name","path"],"io.cozy.contacts":["displayName","fullname","email[]:address","address[]:formattedAddress","phone[]:number","cozy[]:url","birthday","company","jobTitle"],"io.cozy.apps":["slug","name"]},y="io.cozy.contacts",h="io.cozy.apps",m="directory",g=(e,t)=>{let i=t.type===m,o="";if(i)o=t.path??"";else{let i=e.find(e=>e._id===t.dir_id);o=i&&i.path?i.path:""}return{...t,_type:"io.cozy.files",path:o}},b=async e=>{let t=await e.getStackClient().fetchJSON("GET","/data/io.cozy.files/_all_docs?Fields=_id,trashed,dir_id,name,path,type,mime,class,metadata.title,metadata.version&DesignDocs=false&include_docs=true");console.log({resp:t});let i=t.rows.map(e=>({id:e.id,...e.doc})),o=i.filter(e=>e.type===m);console.log({files:i,folders:o});let n=e=>!e.trashed&&!/^\/\.cozy_trash/.test(e.path??""),r=e=>void 0!==o.find(t=>t._id===e.dir_id),l=e=>"io.cozy.files.root-dir"!==e._id,a=e=>"io.cozy.files.shared-drives-dir"!==e._id,c=i.filter(e=>n(e)&&r(e)&&l(e)&&a(e));return console.log("normalizedFilesPrevious",c),c.map(e=>g(o,e))},v=e=>e.queryAll((0,l.Q)(y).limitBy(1e3)),_=e=>e.queryAll((0,l.Q)(h).limitBy(1e3)),z=s()("\uD83D\uDDC2️ [Indexing]"),x=async e=>{z.debug("Initializing indexes");let t=k("io.cozy.files",await b(e)),i=k("io.cozy.contacts",await v(e)),o=k("io.cozy.apps",await _(e));return z.debug("Finished initializing indexes"),[t,i,o]},w=(e,t)=>{z.debug("Searching on indexes");let i=[];for(let o of t){let t=o.search(e,10,{enrich:!0});i=i.concat(t)}return z.debug("Finished seaching on indexes"),i},O=e=>{let t=e.flatMap(e=>e.result.map(t=>({...t,field:e.field}))),i=new Map;return t.forEach(e=>{let{id:t,field:o,...n}=e;i.has(t)?i.get(t).fields.push(o):i.set(t,{id:t,fields:[o],...n})}),[...i.values()]},k=(e,t)=>{let i=p[e],o=new u.Z.Document({tokenize:"forward",encode:f.cv,document:{id:"_id",index:i,store:!0}});for(let e of(console.log("[INDEX] start index docs"),console.log("first doc to index: ",t[0]),console.time("indexDocs"),t))o.add(e);return console.timeEnd("indexDocs"),o},j=e=>"io.cozy.files"===e._type,S=e=>e._type===y,C=e=>e._type===h,E=(e,t,i)=>{let o=T(e,t.doc),n=N(t.doc),r=P(t.doc),l=D(e,t,i);return{doc:t.doc,type:n,title:r,name:l,url:o}},P=e=>j(e)?e.name:S(e)?e.displayName||e.fullname:C(e)?e.name:void 0,D=(e,t,i)=>{if(j(t.doc))return t.doc.path;if(S(t.doc)){let e;let o=t.fields.find(e=>"displayName"!==e&&"fullname"!==e);if(!o)return null;if(console.log("look for field ",o),o.includes("[]:")){let n=o.split("[]:");if(2!==n.length)return null;let r=n[0],l=n[1];e=(t.doc[r]&&t.doc[r].find(e=>e[l]&&e[l].includes(i)))[l]}else e=t.doc[o];return console.log("matching value contact : ",e),e}if(t.doc._type===h)try{let i=e.instanceOptions.locale||"en";if(t.doc.locales[i])return t.doc.locales[i].short_description}catch{return t.doc.name}return null},N=e=>{if(j(e))return l.models.file.isNote(e)?"notes":"drive";return S(e)?"contacts":C(e)?e.slug:null},T=(e,t)=>{let i="",o=N(t);if(j(t)){let e=t.type===m,o=e?t._id:t.dir_id,n=`/folder/${o}`;i=l.models.file.isNote(t)?`/n/${t._id}`:l.models.file.shouldBeOpenedByOnlyOffice(t)?`/onlyoffice/${t._id}?redirectLink=drive${n}`:e?n:`${n}/file/${t._id}`}return(S(t)&&(i=`/${t._id}`),o)?(0,l.generateWebLink)({cozyUrl:e.getStackClient().uri,slug:o,subDomainType:e.getInstanceOptions().subdomain,hash:i,pathname:"",searchParams:[]}):null},$=s()("\uD83D\uDC77‍♂️ [shared-worker]");s().enable();let A={setClient:async e=>{$.debug("Received data for setting client"),(o=new(a())({uri:e.uri,token:e.token,appMetadata:{slug:"cozy-data-proxy",version:"1"},schema:d,store:!0})).instanceOptions=e.instanceOptions,o.capabilities=e.capabilities,!n&&(n=await x(o))},search:async e=>{if($.debug("Received data for search"),!o)throw Error("Client is required to execute a seach, please initialize CozyClient");if(!n)return[];$.debug("[SEARCH] indexes : ",n);let t=w(e,n);console.log("[SEARCH] results : ",t);let i=O(t);return console.log("[SEARCH] dedup : ",i),i.map(t=>E(o,t,e))}};onconnect=e=>{let t=e.ports[0];r.Jj(A,t)}},17770:function(){},18925:function(){}},t={};function i(o){var n=t[o];if(void 0!==n)return n.exports;var r=t[o]={id:o,loaded:!1,exports:{}};return e[o].call(r.exports,r,r.exports,i),r.loaded=!0,r.exports}i.m=e,i.x=()=>{var e=i.O(void 0,["465","361","689","187"],function(){return i("11916")});return e=i.O(e)},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,{a:t}),t},i.d=function(e,t){for(var o in t)i.o(t,o)&&!i.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},i.f={},i.e=function(e){return Promise.all(Object.keys(i.f).reduce(function(t,o){return i.f[o](e,t),t},[]))},i.u=function(e){return"187"===e?"static/js/async/187.4f18c038.js":"static/js/"+(({361:"lib-react",465:"cozy"})[e]||e)+"."+({361:"6a191116",465:"8ab9261a",689:"2ecc0aa7"})[e]+".js"},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.nmd=function(e){return e.paths=[],!e.children&&(e.children=[]),e},(()=>{var e=[];i.O=function(t,o,n,r){if(o){r=r||0;for(var l=e.length;l>0&&e[l-1][2]>r;l--)e[l]=e[l-1];e[l]=[o,n,r];return}for(var a=1/0,l=0;l<e.length;l++){for(var o=e[l][0],n=e[l][1],r=e[l][2],c=!0,s=0;s<o.length;s++)(!1&r||a>=r)&&Object.keys(i.O).every(function(e){return i.O[e](o[s])})?o.splice(s--,1):(c=!1,r<a&&(a=r));if(c){e.splice(l--,1);var d=n();void 0!==d&&(t=d)}}return t}})(),i.p="/",i.rv=function(){return"1.0.8"},(()=>{var e=i.x;i.x=function(){return Promise.all(["465","361","689","187"].map(i.e,i)).then(e)}})(),(()=>{var e={168:1};i.f.i=function(t,o){!e[t]&&importScripts(i.p+i.u(t))};var t=self.webpackChunkcozy_web_data_proxy=self.webpackChunkcozy_web_data_proxy||[],o=t.push.bind(t);t.push=function(t){var n=t[0],r=t[1],l=t[2];for(var a in r)i.o(r,a)&&(i.m[a]=r[a]);for(l&&l(i);n.length;)e[n.pop()]=1;o(t)}})(),i.ruid="bundler=rspack@1.0.8",i.x()})();